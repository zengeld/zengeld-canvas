name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Rust tests and checks
  rust:
    name: Rust ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Setup Python (for pyo3)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all --check

      - name: Clippy
        run: cargo clippy --workspace -- -D warnings

      - name: Run tests
        run: cargo test --all-features

  # Python bindings build test
  python:
    name: Python ${{ matrix.python }} / ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install maturin
        run: pip install maturin

      - name: Build Python package
        run: maturin build --release
        working-directory: crates/canvas-py

      - name: Install and test
        shell: bash
        run: |
          pip install target/wheels/*.whl
          python -c "
          import zengeld_canvas as zc
          print('Version:', zc.version())
          bar = zc.Bar(1703721600, 100.0, 105.0, 99.0, 103.0, 1000.0)
          assert bar.is_bullish() == True
          viewport = zc.Viewport(800.0, 600.0)
          assert viewport.chart_width == 800.0
          theme = zc.Theme.dark()
          assert theme.bg_color == '#131722'
          print('All tests passed!')
          "

  # WASM build test
  wasm:
    name: WASM
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: cargo install wasm-pack

      - name: Build WASM (web)
        run: wasm-pack build --target web --out-dir pkg
        working-directory: crates/canvas-wasm

      - name: Build WASM (nodejs)
        run: wasm-pack build --target nodejs --out-dir pkg-node
        working-directory: crates/canvas-wasm

      - name: Test with Node.js
        run: |
          node -e "
          const wasm = require('./pkg-node/zengeld_canvas_wasm.js');
          console.log('Version:', wasm.version());
          const bar = new wasm.JsBar(1703721600n, 100.0, 105.0, 99.0, 103.0, 1000.0);
          console.log('Bar isBullish:', bar.isBullish());
          const viewport = new wasm.JsViewport(800.0, 600.0);
          console.log('Viewport:', viewport.chartWidth, 'x', viewport.chartHeight);
          const theme = wasm.JsTheme.dark();
          console.log('Theme bg:', theme.bgColor);
          console.log('All tests passed!');
          "
        working-directory: crates/canvas-wasm
